
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Full code and analysis â€” KD and Tokyo's air sources</title>
<link href="_static/css/theme.css" rel="stylesheet"/>
<link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet"/>
<link href="_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="_static/pygments.css" rel="stylesheet" type="text/css">
<link href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" rel="stylesheet" type="text/css">
<link href="_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="_static/mystnb.css" rel="stylesheet" type="text/css">
<link href="_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
<link href="_static/custom.css" rel="stylesheet" type="text/css"/>
<link href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" rel="stylesheet" type="text/css"/>
<link href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" rel="stylesheet" type="text/css"/>
<link as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js" rel="preload"/>
<script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
<script src="_static/jquery.js"></script>
<script src="_static/underscore.js"></script>
<script src="_static/doctools.js"></script>
<script src="_static/clipboard.min.js"></script>
<script src="_static/copybutton.js"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="_static/togglebutton.js"></script>
<script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "AlFontal/vasculitis2022-conference");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
<script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
<script async="async" src="_static/sphinx-thebe.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<link href="https://alfontal.github.io/vasculitis2022-conference/kd_tokyo_air_sources.html" rel="canonical">
<link href="_static/favicon.ico" rel="shortcut icon"/>
<link href="genindex.html" rel="index" title="Index"/>
<link href="search.html" rel="search" title="Search"/>
<link href="poster.html" rel="next" title="Poster"/>
<link href="summary.html" rel="prev" title="Tracing Tokyoâ€™s air sources to identify Kawasaki Diseaseâ€™s etiological triggers"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TC2X861BC8"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-TC2X861BC8');
                </script>
</link></link></link></link></link></link></head>
<body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
<div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="_static/logo.png"/>
<h1 class="site-logo" id="site-title">KD and Tokyo's air sources</h1>
</a>
</div><form action="search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="summary.html">
   Tracing Tokyoâ€™s air sources to identify Kawasaki Diseaseâ€™s etiological triggers
  </a>
</li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active">
<a class="current reference internal" href="#">
   Full code and analysis
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="poster.html">
   Poster Image
  </a>
</li>
</ul>
</div>
</nav> <!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
<div>
<hr/>
<a href="https://helical-itn.eu/">
<img src="https://helical-itn.eu/wp-content/uploads/2020/01/cropped-HELICAL_logo-3.png" width="200px"/>
</a>
<p></p>
<a href="https://www.isglobal.org/en/-/clima-y-salud">
<img src="https://www.isglobal.org/isglobal-new-theme/assets/images/isglobal/logo-isglobal-en.png" width="200px"/>
</a>
<hr/>
<a href="https://www.linkedin.com/in/alfontal/">
<img alt="Alejandro Fontal" class="profile" src="https://avatars.githubusercontent.com/u/10958332?s=400&amp;u=51edd1406d2af0c2f1723a0bf8f111d48a1b7fe7&amp;v=4"/>
<p style="text-align: center; font-size:16px"><b>Alejandro Fontal</b></p>
</a>
<a class="fa fa-github" href="https://github.com/AlFontal" style="font-size: 25px;"></a>
<a class="fa fa-linkedin" href="https://www.linkedin.com/in/alfontal/" style="font-size: 25px;"></a>
<a class="fa fa-twitter" href="https://twitter.com/alefontal" style="font-size: 25px;"></a>
<a class="fa fa-envelope" href="mailto:alejandro.fontal.92@gmail.com" style="font-size: 25px;"></a>
</div>
</div>
</div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
<div class="topbar container-xl fixed-top">
<div class="topbar-contents row">
<div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
<div class="col pl-md-4 topbar-main">
<button aria-controls="site-navigation" aria-expanded="true" aria-label="Toggle navigation" class="navbar-toggler ml-0" data-placement="left" data-target=".site-navigation" data-toggle="tooltip" id="navbar-toggler" title="Toggle navigation" type="button">
<i class="fas fa-bars"></i>
<i class="fas fa-arrow-left"></i>
<i class="fas fa-arrow-up"></i>
</button>
<div class="dropdown-buttons-trigger">
<button aria-label="Download this page" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-download"></i></button>
<div class="dropdown-buttons">
<!-- ipynb file if we had a myst markdown file -->
<!-- Download raw file -->
<a class="dropdown-buttons" href="_sources/kd_tokyo_air_sources.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Download source file" type="button">.ipynb</button></a>
<!-- Download PDF via print -->
<button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" id="download-print" onclick="printPdf(this)" title="Print to PDF" type="button">.pdf</button>
</div>
</div>
<!-- Source interaction buttons -->
<div class="dropdown-buttons-trigger">
<button aria-label="Connect with source repository" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fab fa-github"></i></button>
<div class="dropdown-buttons sourcebuttons">
<a class="repository-button" href="https://github.com/AlFontal/vasculitis2022-conference"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Source repository" type="button"><i class="fab fa-github"></i>repository</button></a>
<a class="issues-button" href="https://github.com/AlFontal/vasculitis2022-conference/issues/new?title=Issue%20on%20page%20%2Fkd_tokyo_air_sources.html&amp;body=Your%20issue%20content%20here."><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Open an issue" type="button"><i class="fas fa-lightbulb"></i>open issue</button></a>
</div>
</div>
<!-- Full screen (wrap in <a> to have style consistency -->
<a class="full-screen-button"><button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode" type="button"><i class="fas fa-expand"></i></button></a>
<!-- Launch buttons -->
<div class="dropdown-buttons-trigger">
<button aria-label="Launch interactive content" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-rocket"></i></button>
<div class="dropdown-buttons">
<a class="binder-button" href="https://mybinder.org/v2/gh/AlFontal/vasculitis2022-conference/master?urlpath=tree/kd_tokyo_air_sources.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Launch Binder" type="button"><img alt="Interact on binder" class="binder-button-logo" src="_static/images/logo_binder.svg"/>Binder</button></a>
</div>
</div>
</div>
<!-- Table of contents -->
<div class="d-none d-md-block col-md-2 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
            </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#imports">
     Imports
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-loading-and-processing">
   Data loading and processing
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#kawasaki-disease">
     Kawasaki Disease
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#full-japanese-temporal-records">
       Full Japanese temporal records
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tokyo-records-2011-2018">
     Tokyo records (2011-2018)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#generating-the-backtrajectories">
   Generating the backtrajectories
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#work-in-progress">
   Work in progress
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="row" id="main-content">
<div class="col-12 col-md-9 pl-md-3 pr-md-0">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Full code and analysis</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#imports">
     Imports
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-loading-and-processing">
   Data loading and processing
  </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#kawasaki-disease">
     Kawasaki Disease
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#full-japanese-temporal-records">
       Full Japanese temporal records
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tokyo-records-2011-2018">
     Tokyo records (2011-2018)
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#generating-the-backtrajectories">
   Generating the backtrajectories
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#work-in-progress">
   Work in progress
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div>
<h1>Table of Contents<span class="tocSkip"></span></h1>
<div class="toc"><ul class="toc-item"><li><span><a data-toc-modified-id="Preamble-1" href="#preamble"><span class="toc-item-num">1Â Â </span>Preamble</a></span><ul class="toc-item"><li><span><a data-toc-modified-id="Imports-1.1" href="#imports"><span class="toc-item-num">1.1Â Â </span>Imports</a></span></li><li><span><a data-toc-modified-id="Pre-sets-1.2" href="#pre-sets"><span class="toc-item-num">1.2Â Â </span>Pre-sets</a></span></li></ul></li><li><span><a data-toc-modified-id="Data-loading-and-processing-2" href="#data-loading-and-processing"><span class="toc-item-num">2Â Â </span>Data loading and processing</a></span><ul class="toc-item"><li><span><a data-toc-modified-id="Kawasaki-Disease-2.1" href="#kawasaki-disease"><span class="toc-item-num">2.1Â Â </span>Kawasaki Disease</a></span><ul class="toc-item"><li><span><a data-toc-modified-id="Full-Japanese-temporal-records-2.1.1" href="#full-japanese-temporal-records"><span class="toc-item-num">2.1.1Â Â </span>Full Japanese temporal records</a></span></li></ul></li><li><span><a data-toc-modified-id="Tokyo-records-(2011-2018)-2.2" href="#tokyo-records-(2011-2018)"><span class="toc-item-num">2.2Â Â </span>Tokyo records (2011-2018)</a></span></li></ul></li><li><span><a data-toc-modified-id="Generating-the-backtrajectories-3" href="#generating-the-backtrajectories"><span class="toc-item-num">3Â Â </span>Generating the backtrajectories</a></span></li><li><span><a data-toc-modified-id="Work-in-progress-4" href="#work-in-progress"><span class="toc-item-num">4Â Â </span>Work in progress</a></span></li></ul></div><div class="tex2jax_ignore mathjax_ignore section" id="full-code-and-analysis">
<h1>Full code and analysis<a class="headerlink" href="#full-code-and-analysis" title="Permalink to this headline">Â¶</a></h1>
<p>This notebook should serve as a guide to reproduce the analysis and figures shown in the poster and
main summary file.</p>
<p>The whole analysis can be performed using <code class="docutils literal notranslate"><span class="pre">Python</span></code> (&lt;3.8) and a local installation of <a class="reference external" href="https://www.ready.noaa.gov/HYSPLIT_register.php">HYSPLIT</a> (follow the link
for the instructions on how to get it installed).</p>
<p>While the full KD registry dataset canâ€™t be shared, we will share the list of dates selected as KD Maxima
and KD Minima so that the trajectory generation can be emulated and reproduced.</p>
<div class="section" id="preamble">
<h2>Preamble<a class="headerlink" href="#preamble" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">import</span> <span class="nn">pysplit</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotnine</span> <span class="k">as</span> <span class="nn">p9</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">mizani.breaks</span> <span class="kn">import</span> <span class="n">date_breaks</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span>
<span class="kn">from</span> <span class="nn">mizani.formatters</span> <span class="kn">import</span> <span class="n">percent_format</span><span class="p">,</span> <span class="n">date_format</span><span class="p">,</span> <span class="n">custom_format</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pre-sets">
<h3>Pre-sets<a class="headerlink" href="#pre-sets" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'dpi'</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'figure_size'</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'base_family'</span><span class="p">,</span> <span class="s1">'Bitstream Vera Serif'</span><span class="p">)</span>
<span class="n">p9</span><span class="o">.</span><span class="n">theme_set</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">theme_bw</span><span class="p">()</span> <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                                      <span class="n">axis_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="data-loading-and-processing">
<h2>Data loading and processing<a class="headerlink" href="#data-loading-and-processing" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="kawasaki-disease">
<h3>Kawasaki Disease<a class="headerlink" href="#kawasaki-disease" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="full-japanese-temporal-records">
<h4>Full Japanese temporal records<a class="headerlink" href="#full-japanese-temporal-records" title="Permalink to this headline">Â¶</a></h4>
<p>We have acces to a pre-processed file with the number of hospital admissions registered as
Kawasaki Disease cases for all of Japan starting from 1970 and up to 2018. For privacy reasons
we are not allowed to share this but since we will just use this to generate the general time
series for the whole period, it shouldnâ€™t be a big deal.</p>
<p>We load a file and show a sample of 10 rows, with the date and the number of registered admissions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kd_japan</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/kawasaki_disease/japan_ts.csv'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'index'</span><span class="p">:</span> <span class="s1">'date'</span><span class="p">})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">kd_japan</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>kd_cases</th>
</tr>
<tr>
<th>date</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<th>1977-11-25</th>
<td>6</td>
</tr>
<tr>
<th>1974-03-13</th>
<td>6</td>
</tr>
<tr>
<th>1970-12-29</th>
<td>0</td>
</tr>
<tr>
<th>2014-06-19</th>
<td>57</td>
</tr>
<tr>
<th>1995-02-27</th>
<td>14</td>
</tr>
<tr>
<th>2006-08-28</th>
<td>47</td>
</tr>
<tr>
<th>2016-05-15</th>
<td>17</td>
</tr>
<tr>
<th>2015-04-27</th>
<td>78</td>
</tr>
<tr>
<th>2015-04-17</th>
<td>61</td>
</tr>
<tr>
<th>1985-12-18</th>
<td>80</td>
</tr>
</tbody>
</table>
</div></div></div>
</div>
<p>If we plot the full temporal series for the daily KD hospital admissions in all of Japan, the figure is the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">kd_japan</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_cases'</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Registered KD Admissions'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Daily KD admissions in Japan (1970-2018)'</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                  <span class="n">axis_title_y</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/kd_tokyo_air_sources_15_0.png" src="_images/kd_tokyo_air_sources_15_0.png">

</img></div>
</div>
<p>While some of the patterns are visible here, the daily variance makes some of the temporal features hard to visualize. Letâ€™s generate the monthly averages of daily admissions and plot the figure again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">kd_japan</span>
 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'M'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_cases'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Registered KD Admissions'</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="s1">'Daily KD admissions in Japan (1970-2018)'</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                                <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                                <span class="n">axis_title_y</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
<span class="p">)</span>
<span class="p">)</span>

 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/kd_tokyo_air_sources_17_0.png" src="_images/kd_tokyo_air_sources_17_0.png">

</img></div>
</div>
<p>Notice how now, 3 features are clearly visible:</p>
<ul class="simple">
<li><p>The three <em>epidemic</em> events during 1979, 1982 and 1986.</p></li>
<li><p>The increasing trend from 2000 on.</p></li>
<li><p>The marked periodicity (yearly seasonality) from 2000 on.</p></li>
</ul>
<p>Taking a closer look to the pre-1990 period:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">kd_japan</span>
 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'M'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">'1990-01-01'</span><span class="p">]</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_cases'</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_area</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Registered KD Admissions'</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="s1">'Daily KD admissions in Japan (1970-1990)'</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                  <span class="n">axis_title_y</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
<span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/kd_tokyo_air_sources_20_0.png" src="_images/kd_tokyo_air_sources_20_0.png">

</img></div>
</div>
<p>The epidemic events are now even more clear!</p>
<p>Letâ€™s look closely to the post 2000 era:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">kd_japan</span>
 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'M'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'2000-01-01'</span><span class="p">:]</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_cases'</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">'kd_cases.rolling(12, center=True).mean()'</span><span class="p">),</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%Y'</span><span class="p">))</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Registered KD Admissions'</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="s1">'Daily KD admissions in Japan (2000-2018)'</span><span class="p">)</span>
 <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
                  <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                  <span class="n">axis_title_y</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
<span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/kd_tokyo_air_sources_22_1.png" src="_images/kd_tokyo_air_sources_22_1.png">

</img></div>
</div>
<p>Both the yearly seasonality and the trend become clear now!</p>
<p>There is a yearly cycle which peaks every winter and has its nadir during the fall, and the trend, represented by the red line (displaying the 12-month moving average), shows a change from ~23 daily cases in the early 2000s to about ~45 daily cases in 2016.</p>
<p>We are undergoing more formal time series analysis work, but for the sake of this example letâ€™s keep it here.</p>
<p>The period from 2016 to 2018 seems to break both the seasonal and trend pattern, and the reasons for these are being studied, but letâ€™s now focus on the data for Tokyo used in this study.</p>
</div>
</div>
<div class="section" id="tokyo-records-2011-2018">
<h3>Tokyo records (2011-2018)<a class="headerlink" href="#tokyo-records-2011-2018" title="Permalink to this headline">Â¶</a></h3>
<p>We have another dataset with the reported dates of onset for a total of 13790 cases diagnosed in hospitals within the prefecture of Tokyo from 2011 to 2018.</p>
<p>Letâ€™s load the already pre-processed file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kd_tokyo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/kawasaki_disease/tokyo_ts.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And visualize the full temporal series:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">kd_tokyo</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rolling_7</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rolling_56</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'cases'</span><span class="p">:</span> <span class="s1">'Daily cases'</span><span class="p">,</span> <span class="s1">'rolling_7'</span><span class="p">:</span> <span class="s1">'7 Days MA'</span><span class="p">,</span> <span class="s1">'rolling_56'</span><span class="p">:</span> <span class="s1">'8 Weeks MA'</span><span class="p">})</span>
 <span class="o">.</span><span class="n">melt</span><span class="p">([</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_alpha_manual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">.2</span><span class="p">])</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">([</span><span class="s1">'black'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%Y-%m'</span><span class="p">),</span> <span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'20 months'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Registered KD cases'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Daily KD cases in Tokyo'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/kd_tokyo_air_sources_28_0.png" src="_images/kd_tokyo_air_sources_28_0.png">

</img></div>
</div>
<p>We can see how for the <em>smaller</em> sample of Tokyo, the temporal patterns become more diffuse, with the daily cases ranging from 0 to 15. As we average over longer periods of time, periods with a consistent increased number of daily cases become more apparent.</p>
<p>For this study, we decided to generate weekly data and select the <strong>top 5</strong> weeks and <strong>bottom 5</strong> weeks with regards to the average number of daily KD cases.</p>
<p>We will now convert the daily data to weekly average of daily cases for all the consecutive weeks in the year (since the last week of the year doesnâ€™t have 7 full days, this should make them still comparable).</p>
<p>As the data was based on admissions up to 31st of December 2018 and the lag from reported onset to actual admission ranges from 2 to 5 days, we removed the data from after the 24th of December 2018 since the data for that last week couldnâ€™t be considered <em>complete</em>.</p>
<p>Letâ€™s process the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kd_weekly_tokyo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kd_tokyo</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">week</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="p">(((</span><span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">52</span><span class="p">))</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'year'</span><span class="p">,</span> <span class="s1">'week'</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now visualize the average number of daily cases per week:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">kd_weekly_tokyo</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'week'</span><span class="p">,</span> <span class="s1">'cases'</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_col</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">strip_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                           <span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s1">'hspace'</span><span class="p">:</span> <span class="mf">.4</span><span class="p">},</span>
                           <span class="n">legend_key_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">legend_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'year'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_manual</span><span class="p">([</span><span class="s1">'#B2182B'</span><span class="p">,</span> <span class="s1">'#2166AC'</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Week of the year'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Mean Daily KD cases'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> 
                          <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
                <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/kd_tokyo_air_sources_33_1.png" src="_images/kd_tokyo_air_sources_33_1.png"/>

</div>
</div>
<p>Letâ€™s now select the weeks associated to the yearly KD maxima and minima:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kd_weekly_tokyo_minmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">kd_weekly_tokyo</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'year'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'cases'</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">'KD Minima'</span><span class="p">),</span>
                              <span class="n">dd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'cases'</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">'KD Maxima'</span><span class="p">)]))</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we now mark the weeks associated to KD Maxima and Minima:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">kd_weekly_tokyo</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'week'</span><span class="p">,</span> <span class="s1">'cases'</span><span class="p">)</span> 
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_col</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_col</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">'label'</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">kd_weekly_tokyo_minmax</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">strip_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                           <span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s1">'hspace'</span><span class="p">:</span> <span class="mf">.4</span><span class="p">},</span>
                           <span class="n">legend_key_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">legend_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'year'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_manual</span><span class="p">([</span><span class="s1">'#B2182B'</span><span class="p">,</span> <span class="s1">'#2166AC'</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Week of the year'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Mean Daily KD cases'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> 
                          <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
                <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/kd_tokyo_air_sources_37_1.png" src="_images/kd_tokyo_air_sources_37_1.png"/>

</div>
</div>
<p>We can now generate a list of single dates that weâ€™ll later use to select the trajectories associated to either KD maxima or minima. This list will be shared so as to enable the reproduction of the differential trajectory analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_weekly_dates</span> <span class="o">=</span> <span class="p">(</span><span class="n">kd_weekly_tokyo_minmax</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">'2011'</span><span class="p">,</span> <span class="s1">'2018-12-31'</span><span class="p">)))</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">week</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="p">(((</span><span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
         <span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">52</span><span class="p">))))</span>
 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">'cases'</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_weekly_dates</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">'../data/kawasaki_disease/kd_min_max_dates.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you want to reproduce the analysis, just read the data running the following cell, and you should be able to follow the next steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_weekly_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'../data/kawasaki_disease/kd_min_max_dates.csv'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="generating-the-backtrajectories">
<h2>Generating the backtrajectories<a class="headerlink" href="#generating-the-backtrajectories" title="Permalink to this headline">Â¶</a></h2>
<p>We will generate the backtrajectories using the <code class="docutils literal notranslate"><span class="pre">pysplit</span></code> library, which allows us to programmatically call HYSPLIT
and generate many trajectories in bulk. For that, however, we need to have (1) a running version of HYSPLIT installed in our local machine, and (2) ARL compatible meteorology files for the period of time we want to run the trajectories.</p>
<p>In this case, we downloaded the GDAS1 meteorology files from the ARL FTP server. These can be accessed through this link.</p>
<p>I am going to define here the local folders where my installation of HYSPLIT is located and where the meteorology files are.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HYSPLIT_DIR</span> <span class="o">=</span> <span class="s1">'/home/afontal/utils/hysplit/exec/hyts_std'</span>
<span class="n">HYSPLIT_WORKING</span> <span class="o">=</span> <span class="s1">'/home/afontal/utils/hysplit/working'</span>
<span class="n">METEO_DIR</span> <span class="o">=</span> <span class="s1">'/home/afontal/utils/hysplit/meteo/gdas1'</span>
<span class="n">OUT_DIR</span> <span class="o">=</span> <span class="s1">'/home/afontal/projects/vasculitis2022-conference/output/trajectories'</span>
</pre></div>
</div>
</div>
</div>
<p>We will now call the <code class="docutils literal notranslate"><span class="pre">generate_bulktraj</span></code> function from the <code class="docutils literal notranslate"><span class="pre">pysplit</span></code> package to generate the trajectories. In previous trials I realized that trying to call too many trajectories at once causes the call to freeze (at least in my local machine) so I ended up splitting the call by months:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">2019</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
    <span class="n">pysplit</span><span class="o">.</span><span class="n">generate_bulktraj</span><span class="p">(</span><span class="s1">'tokyo'</span><span class="p">,</span>
                              <span class="n">hysplit_working</span><span class="o">=</span><span class="n">HYSPLIT_WORKING</span><span class="p">,</span>
                              <span class="n">hysplit</span><span class="o">=</span><span class="n">HYSPLIT_DIR</span><span class="p">,</span>
                              <span class="n">output_dir</span><span class="o">=</span><span class="n">OUT_DIR</span><span class="p">,</span>
                              <span class="n">meteo_dir</span><span class="o">=</span><span class="n">METEO_DIR</span><span class="p">,</span>
                              <span class="n">years</span><span class="o">=</span><span class="p">[</span><span class="n">year</span><span class="p">],</span>
                              <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="n">month</span><span class="p">],</span>
                              <span class="n">meteoyr_2digits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">hours</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
                              <span class="n">altitudes</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
                              <span class="n">coordinates</span><span class="o">=</span><span class="p">(</span><span class="mf">35.68</span><span class="p">,</span> <span class="mf">139.65</span><span class="p">),</span>
                              <span class="n">run</span><span class="o">=-</span><span class="mi">96</span><span class="p">,</span>
                              <span class="n">meteo_bookends</span><span class="o">=</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[])</span>

    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="work-in-progress">
<h2>Work in progress<a class="headerlink" href="#work-in-progress" title="Permalink to this headline">Â¶</a></h2>
<p>Come later to see the full code. Or contact <a class="reference external" href="mailto:alejandro.fontal%40isglobal.org">alejandro<span>.</span>fontal<span>@</span>isglobal<span>.</span>org</a></p>
</div>
</div>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3810jvsc74a57bd089648fb152502fbcbc7b7606006af7f7d574bf18000f2a44f512ddc99300b486",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3810jvsc74a57bd089648fb152502fbcbc7b7606006af7f7d574bf18000f2a44f512ddc99300b486'</script>
</div>
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="summary.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Tracing Tokyoâ€™s air sources to identify Kawasaki Diseaseâ€™s etiological triggers</p>
</div>
</a>
<a class="right-next" href="poster.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Poster</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</div>
</div>
<footer class="footer">
<p>
    
      By Alejandro Fontal<br/>
    
        Â© Copyright 2022.<br/>
</p>
</footer>
</main>
</div>
</div>
<script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
</body>
</html>